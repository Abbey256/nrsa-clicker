<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NRSA Judge</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }

        .tap-highlight-transparent {
            -webkit-tap-highlight-color: transparent;
        }

        /* LOADER STYLES */
        #app-loader {
            position: fixed;
            inset: 0;
            background: #111827;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #374151;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- GLOBAL LOADER -->
    <div id="app-loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-blue-500 font-bold tracking-widest animate-pulse">AUTHENTICATING...</h2>
    </div>

    <!-- VIEW 2: LOBBY -->
    <div id="viewLobby" class="flex-1 flex flex-col px-6 py-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold text-gray-300">Welcome, Judge</h2>
            <button id="logoutBtn"
                class="text-sm text-red-400 border border-red-400/30 px-3 py-1 rounded-full">Logout</button>
        </div>

        <div class="flex-1 flex flex-col justify-center space-y-6">

            <!-- Match Status -->
            <div id="matchStatusCard" class="bg-gray-800 rounded-2xl p-6 text-center border border-gray-700">
                <p class="text-gray-400 text-sm uppercase tracking-wider mb-2">Current Status</p>
                <h3 id="lobbyMatchName" class="text-2xl font-bold text-white mb-1">Waiting...</h3>
                <span id="lobbyStatusBadge"
                    class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-400">OFFLINE</span>
            </div>

            <div id="stationSelection" class="space-y-4 opacity-50 pointer-events-none transition-opacity duration-300">
                <p class="text-center text-gray-500 text-sm mb-2">Select Your Station</p>
                <button data-station="1"
                    class="station-btn w-full bg-gray-800 hover:bg-gray-700 p-6 rounded-2xl border-2 border-gray-700 flex items-center justify-between group transition-all">
                    <span class="text-2xl font-bold text-gray-300 group-hover:text-white">Station 1</span>
                    <div class="status-indicator w-4 h-4 rounded-full bg-green-500"></div>
                </button>
                <button data-station="2"
                    class="station-btn w-full bg-gray-800 hover:bg-gray-700 p-6 rounded-2xl border-2 border-gray-700 flex items-center justify-between group transition-all">
                    <span class="text-2xl font-bold text-gray-300 group-hover:text-white">Station 2</span>
                    <div class="status-indicator w-4 h-4 rounded-full bg-green-500"></div>
                </button>
                <button data-station="3"
                    class="station-btn w-full bg-gray-800 hover:bg-gray-700 p-6 rounded-2xl border-2 border-gray-700 flex items-center justify-between group transition-all">
                    <span class="text-2xl font-bold text-gray-300 group-hover:text-white">Station 3</span>
                    <div class="status-indicator w-4 h-4 rounded-full bg-green-500"></div>
                </button>
            </div>

        </div>
    </div>

    <!-- VIEW 3: SCORING -->
    <div id="viewScoring" class="flex-1 flex flex-col hidden h-screen overflow-hidden">
        <!-- Header -->
        <header class="bg-gray-800 px-6 py-4 flex justify-between items-center shadow-md z-10">
            <div>
                <h1 class="text-lg font-bold text-gray-200">Station <span id="scoreStationId">1</span></h1>
                <p id="disciplineCode" class="text-xs text-blue-400 font-mono tracking-wider">LOADING...</p>
                <!-- NEW: Now Judging Label -->
                <p id="nowJudgingLabel" class="text-[10px] text-gray-400 font-bold uppercase mt-1">Now Judging: ...</p>
            </div>
            <div class="bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-500/30">
                <span class="text-xs text-blue-300 font-bold">LIVE</span>
            </div>
        </header>

        <!-- Identity Card -->
        <div class="bg-gradient-to-r from-blue-900 to-purple-900 p-4 text-center shadow-lg relative z-0">
            <p class="text-xs text-blue-200 uppercase tracking-widest opacity-75 mb-1">Judging Team</p>
            <h2 id="scoringSchoolName" class="text-2xl font-extrabold text-white truncate px-2">Loading...</h2>
        </div>

        <!-- The Counter -->
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <!-- Locked Message -->
            <div id="lockedMessage" class="hidden text-center p-8 animate-fade-in z-30">
                <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg shadow-xl"
                    role="alert">
                    <p class="font-bold text-xl mb-2">✅ Score Recorded</p>
                    <p>Score for this discipline has been recorded.</p>
                    <p class="mt-2 text-sm opacity-75">Please wait for the Chief Judge to call the next event.</p>
                </div>
            </div>

            <!-- Scoring Controls Container -->
            <div id="scoringControls" class="contents">
                <!-- Ripple Effect Container -->
                <div id="clickRipple" class="absolute inset-0 pointer-events-none overflow-hidden"></div>

                <button id="counterBtn"
                    class="w-64 h-64 rounded-full bg-gray-800 border-8 border-gray-700 shadow-2xl flex flex-col items-center justify-center active:bg-gray-700 active:scale-95 transition-all tap-highlight-transparent z-10 touch-manipulation user-select-none">
                    <span id="scoreValue" class="text-8xl font-black text-white font-mono pointer-events-none">0</span>
                    <span class="text-xs text-gray-500 mt-2 uppercase tracking-widest pointer-events-none">Tap to
                        Score</span>
                </button>

                <!-- Minus / Reset -->
                <div class="absolute bottom-10 flex space-x-6 z-20">
                    <button id="decBtn"
                        class="w-16 h-16 rounded-full bg-gray-800 border border-gray-600 text-gray-400 flex items-center justify-center active:bg-red-900/50 active:text-red-400 text-2xl font-bold shadow-lg">
                        &minus;
                    </button>
                    <button id="resetBtn"
                        class="w-16 h-16 rounded-full bg-gray-800 border border-gray-600 text-gray-400 flex items-center justify-center active:bg-yellow-900/50 active:text-yellow-400 text-sm font-bold shadow-lg">
                        RST
                    </button>
                </div>
            </div>
        </div>

        <!-- Submit Footer -->
        <div class="bg-gray-800 p-4 pb-8 border-t border-gray-700 z-10">
            <button id="submitScoreBtn"
                class="w-full bg-green-600 active:bg-green-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg flex items-center justify-center">
                <span>Submit Score</span>
            </button>
        </div>
    </div>

    <script>
        // --- CONFIG MATCH ---
        if (!CONFIG || !CONFIG.SUPABASE_URL) {
            alert("Missing Config");
            throw new Error("Missing Config");
        }

        const sbClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        const MAO_ORDERS = {
            'A': ['SRSS', 'SRDU', 'SRSE', 'DDSR', 'SROF', 'SRCC', 'LMS', 'DDS', 'SRSR'],
            'B': ['SROF', 'SRCC', 'LMS', 'DDS', 'SRSR', 'SRSS', 'SRDU', 'SRSE', 'DDSR']
        };

        // --- STATE ---
        const state = {
            user: null,
            view: 'lobby', // defaulting to lobby, as login is external
            activeMatch: null,
            station: null,
            score: 0,
            lockedStations: [] // IDs of locked stations
        };

        // --- DOM ---
        const $ = (id) => document.getElementById(id);
        const views = {
            lobby: $('viewLobby'),
            scoring: $('viewScoring')
        };

        // --- AUTH ---
        // --- AUTH ---
        async function checkSession() {
            try {
                const loader = document.getElementById('app-loader');

                // 1. Session Check
                const { data: { session } } = await sbClient.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                    return;
                }

                // 2. Role Check (Gatekeeper)
                const { data: profile } = await sbClient.from('admin_profiles').select('*').eq('id', session.user.id).single();

                if (!profile) {
                    await sbClient.auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }

                // 3. STRICT REDIRECT
                if (profile.role === 'chief_judge' || profile.role === 'super_admin') {
                    window.location.href = 'admin.html';
                    return;
                }

                state.user = session.user;

                // 4. Ghost Prevention
                sessionStorage.removeItem('active_match_id');

                // 5. Unlock UI
                if (loader) loader.style.display = 'none';

                switchView('lobby');
                initLobby();

            } catch (err) {
                console.error("Auth Error:", err);
                alert("Login Failed");
            }
        }

        $('logoutBtn').addEventListener('click', async () => {
            await sbClient.auth.signOut();
            window.location.href = 'index.html';
        });

        // --- VIEW MANAGER ---
        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            state.view = viewName;
        }

        // --- LOBBY LOGIC ---
        function initLobby() {
            fetchActiveMatch();
            fetchStationLocks();

            // Subscriptions
            sbClient.channel('lobby_updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, payload => {
                    fetchActiveMatch();
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'station_assignments' }, payload => {
                    // If new lock, update UI
                    lockStationBtn(payload.new.station_id);
                })
                .subscribe();
        }

        async function fetchActiveMatch() {
            console.log("Fetching Active Match...");
            const { data, error } = await sbClient.from('matches')
                .select('*, disciplines(code)') // Fetch code for index
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (error) console.error("Judge Fetch Error:", error);
            console.log("Judge Match Data:", data);

            if (data) {
                state.activeMatch = data;
                $('lobbyMatchName').textContent = data.match_name || 'Match #' + data.id;
                $('lobbyStatusBadge').textContent = 'LIVE';
                $('lobbyStatusBadge').className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400 border border-green-500/50 animate-pulse';
                $('stationSelection').classList.remove('opacity-50', 'pointer-events-none');

                // Sync Timer
                if (data.timer_status === 'running' && data.start_time) {
                    startJudgeTimer(data.start_time, data.disciplines?.code);
                } else {
                    stopJudgeTimer();
                }

            } else {
                state.activeMatch = null;
                $('lobbyMatchName').textContent = 'Waiting for Chief Judge...';
                $('lobbyStatusBadge').textContent = 'OFFLINE';
                $('lobbyStatusBadge').className = 'inline-block px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-400';
                $('stationSelection').classList.add('opacity-50', 'pointer-events-none');
                stopJudgeTimer();
            }
        }

        // TIMER LOGIC FOR JUDGE
        let judgeTimerInterval = null;
        function startJudgeTimer(startTimeStr, discCode) {
            const DURATIONS = {
                'SRSS': 30, 'SRDU': 30, 'SRCC': 30, 'SROF': 30, 'SRSE': 30,
                'DDS': 60,
                'SRSR': 120, 'DDSR': 120,
                'LMS': 0
            };
            const duration = DURATIONS[discCode] || 30;

            if (duration === 0) {
                const badge = document.querySelector('.bg-blue-900\\/30 span');
                if (badge) badge.textContent = "LIVE";
                return;
            }

            const startTime = new Date(startTimeStr).getTime();

            if (judgeTimerInterval) clearInterval(judgeTimerInterval);

            judgeTimerInterval = setInterval(() => {
                const now = new Date().getTime();
                const elapsed = (now - startTime) / 1000;
                const remaining = Math.max(0, duration - elapsed);

                const mm = Math.floor(remaining / 60).toString().padStart(2, '0');
                const ss = Math.floor(remaining % 60).toString().padStart(2, '0');

                // Update the LIVE badge to show Timer
                const badge = document.querySelector('.bg-blue-900\\/30 span');
                if (badge) {
                    badge.textContent = `${mm}:${ss}`;
                    if (remaining <= 10) badge.classList.add('text-red-400', 'animate-pulse');
                    else badge.classList.remove('text-red-400', 'animate-pulse');
                }

                if (remaining <= 0) clearInterval(judgeTimerInterval);

            }, 500);
        }

        function stopJudgeTimer() {
            if (judgeTimerInterval) clearInterval(judgeTimerInterval);
            const badge = document.querySelector('.bg-blue-900\\/30 span');
            if (badge) {
                badge.textContent = "LIVE";
                badge.classList.remove('text-red-400', 'animate-pulse');
            }
        }

        async function fetchStationLocks() {
            if (!state.activeMatch) return;

            // Updated: Fetch user_id as well to distinguish "My Lock" vs "Other Lock"
            const { data } = await sbClient.from('station_assignments')
                .select('station_id, user_id')
                .eq('match_id', state.activeMatch.id)
                .eq('status', 'LOCKED');

            if (data) {
                data.forEach(row => {
                    const isMyLock = (state.user && row.user_id === state.user.id);
                    updateStationBtn(row.station_id, isMyLock);
                });
            }
        }

        function updateStationBtn(stationId, isMyLock) {
            const btn = document.querySelector(`button[data-station="${stationId}"]`);
            if (btn) {
                if (isMyLock) {
                    // RESUME STATE
                    btn.disabled = false; // Enabled!
                    btn.classList.remove('opacity-50', 'bg-gray-900', 'cursor-not-allowed', 'bg-gray-800');
                    btn.classList.add('bg-green-900/40', 'border-green-500', 'text-green-100'); // distinct style
                    btn.querySelector('span').textContent = `Resume Station ${stationId}`;
                    btn.querySelector('.status-indicator').classList.replace('bg-green-500', 'bg-green-400');
                    btn.dataset.lockedByMe = "true"; // Marker for click handler
                } else {
                    // LOCKED STATE
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'bg-gray-900', 'cursor-not-allowed');
                    btn.querySelector('span').textContent = `Station ${stationId} (Locked)`;
                    btn.querySelector('.status-indicator').classList.replace('bg-green-500', 'bg-red-500');
                    btn.dataset.lockedByMe = "false";
                }
            }
        }

        // Station Click
        document.querySelectorAll('.station-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!state.activeMatch) return;

                const stationId = parseInt(btn.dataset.station);

                // 0. Resume Check (Client-side optimization)
                if (btn.dataset.lockedByMe === "true") {
                    state.station = stationId;
                    initScoring();
                    return;
                }

                // 1. Server-side Check: Do I have ANY lock for this match?
                const { data: existingLock } = await sbClient
                    .from('station_assignments')
                    .select('*')
                    .eq('match_id', state.activeMatch.id)
                    .eq('user_id', state.user.id)
                    .maybeSingle();

                if (existingLock) {
                    if (existingLock.station_id === stationId) {
                        // It IS mine matching (redundant safety)
                        state.station = stationId;
                        initScoring();
                        return;
                    } else {
                        // Switch Seats: Delete old lock first
                        await sbClient.from('station_assignments').delete().eq('id', existingLock.id);
                    }
                }

                // 2. Insert New Lock
                const { error } = await sbClient.from('station_assignments').insert([{
                    station_id: stationId,
                    match_id: state.activeMatch.id,
                    user_id: state.user.id,
                    status: 'LOCKED'
                }]);

                if (error) {
                    // Check for 409 / Unique Violation
                    if (error.code === '23505' || error.message.includes('unique')) {
                        // Check if occupied by someone else
                        const { data: owner } = await sbClient.from('station_assignments')
                            .select('user_id')
                            .eq('match_id', state.activeMatch.id)
                            .eq('station_id', stationId)
                            .maybeSingle();

                        if (owner && owner.user_id !== state.user.id) {
                            Toastify({
                                text: "Station is occupied by another judge.",
                                duration: 3000,
                                gravity: "top",
                                position: "center",
                                style: { background: "#ef4444" }
                            }).showToast();
                        } else {
                            // My ownership confirmed
                            state.station = stationId;
                            initScoring();
                        }
                    } else {
                        Toastify({
                            text: "Error: " + error.message,
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            style: { background: "#ef4444" }
                        }).showToast();
                    }
                    fetchStationLocks(); // refresh UI
                } else {
                    state.station = stationId;
                    initScoring();
                }
            });
        });

        // --- SCORING LOGIC ---
        function initScoring() {
            switchView('scoring');
            $('scoreStationId').textContent = state.station;
            // Assuming discipline code is on match or fetched separately.
            // Prompt says: "Display Current Discipline Code". 
            // Let's assume matches table has it or we fetch active discipline.
            // For now, placeholder or 'SRSS' as example. 
            // If match has active_discipline_id, we'd fetch that.
            $('disciplineCode').textContent = state.activeMatch.active_discipline_id || 'DISCIPLINE';

            updateSchoolDisplay();
            checkExistingScore(); // NEW: Check lock
            resetCounter();

            // Subscribe to Match Teams for Rotation
            sbClient.channel('scoring_updates')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'match_teams', filter: `match_id=eq.${state.activeMatch.id}` }, payload => {
                    // Check if *our* station was affected
                    // Wait, payload tells us the NEW row. 
                    // If rows update station_assignment, we need to find which school is NOW at state.station.
                    // Easier to just Refetch on any update to match_teams for this match.
                    updateSchoolDisplay(true); // true = isRotation
                })
                .subscribe();
        }

        async function updateSchoolDisplay(isRotation = false) {

            // ROTATION LOGIC:
            // 1. Identify Discipline Index
            const currentCode = state.activeMatch.active_discipline_id;
            const mao = state.activeMatch.mao_option || 'A';
            const order = MAO_ORDERS[mao] || MAO_ORDERS['A'];
            const discIndex = order.indexOf(currentCode);

            // 2. Calculate BASE Team Slot (Who is physically here?)
            // Formula: Slot = ((Station - 1 - Index) % 3 + 3) % 3 + 1
            const baseSlot = ((state.station - 1 - discIndex) % 3 + 3) % 3 + 1;

            console.log(`Station ${state.station}, DiscIndex ${discIndex} (${currentCode}) => BaseSlot ${baseSlot}`);

            // Find school at BASE SLOT (permanent assignment)
            const { data, error } = await sbClient.from('match_teams')
                .select('team_id, schools:team_id(name)')
                .eq('match_id', state.activeMatch.id)
                .eq('station_assignment', baseSlot) // Query BASE SLOT
                .single();

            if (data && data.schools) {
                // If school changed, auto-reset
                const newSchool = data.schools.name.toUpperCase();
                const currentName = $('scoringSchoolName').textContent;

                // Update Badge
                $('nowJudgingLabel').textContent = `Now Judging: ${newSchool}`;

                if (isRotation || newSchool !== currentName) {
                    // Flash effect
                    $('scoringSchoolName').classList.add('text-yellow-400');
                    setTimeout(() => $('scoringSchoolName').classList.remove('text-yellow-400'), 500);
                    resetCounter();
                }

                $('scoringSchoolName').textContent = newSchool;
                state.resultSchoolId = data.team_id;
            } else {
                $('scoringSchoolName').textContent = "Waiting for Team...";
                $('nowJudgingLabel').textContent = "Now Judging: ...";
            }
        }

        // Counter Logic
        $('counterBtn').addEventListener('click', (e) => {
            e.preventDefault();
            // Visual Ripple
            // increment
            state.score++;
            updateCounterUI();

            // Vibration
            if (navigator.vibrate) navigator.vibrate(50);
        });

        $('counterBtn').addEventListener('touchstart', (e) => {
            e.preventDefault(); // prevent zoom/scroll
            $('counterBtn').click();
        }, { passive: false });

        $('decBtn').addEventListener('click', () => {
            if (state.score > 0) state.score--;
            updateCounterUI();
        });

        $('resetBtn').addEventListener('click', () => {
            if (confirm("Reset score to 0?")) resetCounter();
        });

        function updateCounterUI() {
            $('scoreValue').textContent = state.score;
        }

        function resetCounter() {
            state.score = 0;
            updateCounterUI();
        }

        // Submit
        // Submit
        $('submitScoreBtn').addEventListener('click', async () => {
            if (!state.activeMatch || !state.resultSchoolId) return;

            const btn = $('submitScoreBtn');
            const originalText = btn.innerHTML;

            // 1. Immediate Lock
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">Sending...</span>`;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const { error } = await sbClient.from('scores').insert([{
                    match_id: state.activeMatch.id,
                    school_id: state.resultSchoolId,
                    station_id: state.station,
                    judge_id: state.user.id,
                    score_points: state.score,
                    discipline_id: state.activeMatch.active_discipline_id
                }]);

                if (error) throw error;

                // Success
                Toastify({
                    text: "Score Submitted Successfully! ✅",
                    duration: 2000,
                    gravity: "top",
                    position: "center",
                    style: { background: "#22c55e" }
                }).showToast();

                // UI Lock immediately
                checkExistingScore();

            } catch (error) {
                console.error("Submit Error:", error);

                let msg = error.message;
                if (error.code === '23505' || msg.includes('unique')) {
                    msg = "Error: This score was already recorded.";
                    // Verify lock anyway just in case
                    checkExistingScore();
                }

                Toastify({
                    text: msg,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "#ef4444" }
                }).showToast();

                // Reset Button if strictly a failure (and not a duplicate which implies success happened elsewhere)
                if (error.code !== '23505') {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }
        });

        // --- SUBMISSION LOCK LOGIC ---
        async function checkExistingScore() {
            if (!state.activeMatch) return;

            const { data } = await sbClient.from('scores')
                .select('id')
                .eq('match_id', state.activeMatch.id)
                .eq('station_id', state.station)
                .eq('discipline_id', state.activeMatch.active_discipline_id)
                .limit(1)
                .maybeSingle();

            const isLocked = !!data;
            const controls = $('scoringControls');
            const msg = $('lockedMessage');
            const submitBtn = $('submitScoreBtn');

            if (isLocked) {
                // HIDE CONTROLS
                if (controls) controls.classList.add('hidden');
                if (msg) msg.classList.remove('hidden');

                // Hide Submit Button container or just button
                if (submitBtn) {
                    submitBtn.parentElement.classList.add('hidden'); // Hide the footer container if possible? 
                    // Actually submit button is in footer. Let's just hide the button itself or disable it fully.
                    submitBtn.classList.add('hidden');
                }
            } else {
                // SHOW CONTROLS
                if (controls) controls.classList.remove('hidden');
                if (msg) msg.classList.add('hidden');
                if (submitBtn) submitBtn.classList.remove('hidden');
            }
        }

        // Start
        checkSession();

    </script>
</body>

</html>