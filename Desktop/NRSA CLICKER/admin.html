<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NRSA Super Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Config File -->
    <script src="config.js"></script>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* LOADER STYLES */
        #app-loader {
            position: fixed;
            inset: 0;
            background: #111827;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #374151;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 flex h-screen overflow-hidden">

    <!-- GLOBAL LOADER -->
    <div id="app-loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-blue-500 font-bold tracking-widest animate-pulse">AUTHENTICATING...</h2>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed top-5 right-5 z-50 flex flex-col space-y-3 pointer-events-none"></div>

    <!-- DASHBOARD (Only View) -->
    <div id="viewDashboard" class="flex w-full h-full hidden">
        <!-- SIDEBAR -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="h-20 flex items-center justify-center border-b border-gray-700 space-x-2">
                <img src="logo.png" alt="NRSA Logo" class="h-10 w-10 object-contain">
                <h1
                    class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    NRSA ADMIN</h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" onclick="switchView('dashboard')" id="nav-dashboard"
                    class="flex items-center px-4 py-3 bg-gray-700 text-white rounded-lg transition-colors nav-item">
                    <span class="mr-3">üìä</span> Dashboard
                </a>

                <a href="#" onclick="switchView('match')" id="nav-match"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition-colors nav-item hidden">
                    <span class="mr-3">‚öîÔ∏è</span> Match Control
                </a>

                <a href="#" onclick="switchView('states')" id="nav-states"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition-colors nav-item">
                    <span class="mr-3">üó∫Ô∏è</span> State Manager
                </a>

                <a href="#" onclick="switchView('schools')" id="nav-schools"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition-colors nav-item">
                    <span class="mr-3">üè´</span> School Manager
                </a>

                <a href="#" onclick="switchView('users')" id="nav-users"
                    class="flex items-center px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition-colors nav-item hidden">
                    <span class="mr-3">üë•</span> User Manager
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div id="userRoleDisplay" class="text-xs text-blue-400 font-bold text-center mb-2 uppercase"></div>
                <button id="logoutBtn"
                    class="w-full flex items-center justify-center px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 hover:text-red-300 rounded-lg transition-colors text-sm font-medium">
                    <span class="mr-2">üö™</span> Sign Out
                </button>
                <div class="text-xs text-gray-500 text-center mt-3">v2.1 Role-Based</div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto bg-gray-900 scroll-smooth">
            <div class="max-w-7xl mx-auto px-8 py-10 space-y-8">

                <!-- VIEW 1: DASHBOARD -->
                <div id="view-dashboard" class="admin-view">
                    <header class="mb-8">
                        <h2 class="text-3xl font-bold text-white">Championship Control</h2>
                        <p class="text-gray-400 mt-1">Manage States, Schools, and Live Matches</p>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stat Card 1 -->
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 font-medium">Total States</h3>
                                <span
                                    class="bg-green-500/20 text-green-400 px-2 py-1 rounded text-xs font-bold">ZONES</span>
                            </div>
                            <p class="text-3xl font-bold text-white" id="stat-active-match">--</p>
                        </div>
                        <!-- Stat Card 2 -->
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 font-medium">Registered Schools</h3>
                                <span
                                    class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-xs font-bold">TOTAL</span>
                            </div>
                            <p class="text-3xl font-bold text-white" id="stat-total-schools">--</p>
                        </div>
                        <!-- Stat Card 3 -->
                        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-gray-400 font-medium">System Users</h3>
                                <span
                                    class="bg-purple-500/20 text-purple-400 px-2 py-1 rounded text-xs font-bold">ADMINS</span>
                            </div>
                            <p class="text-3xl font-bold text-white" id="stat-total-users">--</p>
                        </div>
                    </div>

                    <!-- DANGER ZONE -->
                    <div class="mt-12 pt-8 border-t border-gray-800">
                        <h3 class="text-red-500 font-bold uppercase text-sm tracking-wider mb-4">Danger Zone</h3>
                        <div
                            class="bg-red-900/10 border border-red-900/30 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div>
                                <h4 class="text-white font-bold text-lg">System Reset</h4>
                                <p class="text-red-400/60 text-sm">Permanently delete ALL matches, scores, and
                                    assignments to start fresh.</p>
                            </div>
                            <button id="emergencyResetBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center shadow-lg transform active:scale-95 duration-200">
                                <span class="mr-2">‚ö†Ô∏è</span> NUKE SYSTEM
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: STATES -->
                <div id="view-states" class="admin-view" style="display: none;">
                    <h3 class="text-2xl font-bold text-white mb-6">State Manager</h3>

                    <!-- STATE LIST TABLE -->
                    <div id="stateList" class="mb-6 overflow-hidden rounded-lg border border-gray-700">
                        <p class="text-gray-500 text-sm p-4 text-center">Loading states...</p>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl max-w-2xl">
                        <form id="stateForm" class="grid grid-cols-2 gap-4">
                            <div class="col-span-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ADD
                                NEW STATE</div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">State Name</label>
                                <input type="text" id="stateName" placeholder="e.g. Delta"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Zone Name</label>
                                <input type="text" id="stateZone" placeholder="e.g. Zone 1"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div class="col-span-2">
                                <button type="submit"
                                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95">
                                    ADD STATE
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- VIEW 3: SCHOOLS -->
                <div id="view-schools" class="admin-view" style="display: none;">
                    <h3 class="text-2xl font-bold text-white mb-6">School Manager</h3>

                    <!-- SCHOOL LIST TABLE -->
                    <div id="schoolList" class="mb-6 overflow-hidden rounded-lg border border-gray-700">
                        <p class="text-gray-500 text-sm p-4 text-center">Loading schools...</p>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl max-w-2xl">
                        <form id="schoolForm" class="space-y-4">
                            <input type="hidden" id="editSchoolId">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"
                                id="schoolFormTitle">ADD NEW SCHOOL</div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">State</label>
                                <select id="schoolStateSelect"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                                    <option value="">Select State</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">School Name</label>
                                <input type="text" id="schoolName" placeholder="e.g. Government Secondary School"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" id="schoolSubmitBtn"
                                    class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95">
                                    ADD SCHOOL
                                </button>
                                <button type="button" id="cancelEditBtn" onclick="cancelSchoolEdit()"
                                    class="hidden px-6 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95">
                                    CANCEL
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- VIEW 4: USERS -->
                <div id="view-users" class="admin-view" style="display: none;">
                    <h3 class="text-2xl font-bold text-white mb-6">User Management</h3>

                    <!-- USER LIST TABLE -->
                    <div id="userList" class="mb-6 overflow-hidden rounded-lg border border-gray-700">
                        <p class="text-gray-500 text-sm p-4 text-center">Loading users...</p>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl max-w-3xl">
                        <form id="userForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-full text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ADD
                                NEW USER</div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Email</label>
                                <input type="email" id="newUserEmail" placeholder="user@example.com"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Password</label>
                                <input type="password" id="newUserPass" placeholder="********"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Role</label>
                                <select id="newUserRole"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                                    <option value="super_admin">Super Admin</option>
                                    <option value="state_admin">State Admin</option>
                                    <option value="chief_judge">Chief Judge</option>
                                    <option value="station_judge">Station Judge</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Assigned State</label>
                                <select id="newUserState"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none text-white placeholder-gray-500">
                                    <option value="0">None (Global)</option>
                                </select>
                            </div>
                            <div class="col-span-full">
                                <button type="submit"
                                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg transform transition active:scale-95">
                                    CREATE USER
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- VIEW 5: MATCH SETUP & CONTROL (Chief Judge) -->
                <div id="view-match" class="admin-view" style="display: none;">

                    <!-- 1. SETUP FORM (Initial State) -->
                    <div id="matchSetupCard" class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl mb-8">
                        <h3 class="text-lg font-semibold text-purple-400 mb-6 flex items-center">
                            <span class="bg-purple-400/10 p-2 rounded-lg mr-3">‚öîÔ∏è</span> Match Setup
                        </h3>
                        <form id="matchForm" class="space-y-6">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Match Name</label>
                                <input type="text" id="matchName" placeholder="e.g. Delta State Finals"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">State for Match</label>
                                <select id="matchStateSelect"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                                    <option value="">Select State</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1">Team 1 School</label>
                                    <select id="school2_1"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                        required>
                                        <option value="">Select School</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1">Team 2 School</label>
                                    <select id="school2_2"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                        required>
                                        <option value="">Select School</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1">Team 3 School</label>
                                    <select id="school2_3"
                                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                        required>
                                        <option value="">Select School</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">MAO Option</label>
                                <select id="maoOption"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white placeholder-gray-500"
                                    required>
                                    <option value="A">Option A (SRSS, SRDU, etc.)
                                    </option>
                                    <option value="B">Option B (SROF, SRCC, etc.)
                                    </option>
                                </select>
                            </div>
                            <button type="submit"
                                class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95">
                                INITIALIZE MATCH
                            </button>
                        </form>
                        <div id="matchMsg" class="mt-3 text-xs text-center min-h-[1.5em]"></div>
                    </div>

                    <!-- 2. LIVE CONTROL PANEL (Active State) -->
                    <div id="liveControlPanel" class="hidden space-y-6">

                        <!-- Header & Progress -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                                <div>
                                    <h2 id="liveMatchTitle" class="text-2xl font-bold text-white">Loading Match...</h2>
                                    <p class="text-orange-400 text-sm font-mono mt-1 animate-pulse">‚óè LIVE BROADCAST</p>
                                </div>
                                <div class="text-right mt-4 md:mt-0">
                                    <div class="text-3xl font-mono font-bold text-white" id="timeElapsed">00:00</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-widest">Duration</div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div
                                class="mb-2 flex justify-between text-xs text-gray-400 uppercase font-bold tracking-wider">
                                <span id="progressText">Discipline 1 of 9</span>
                                <span id="activeDisciplineName">--</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                                <div id="matchProgressBar"
                                    class="bg-gradient-to-r from-orange-500 to-red-600 h-full rounded-full transition-all duration-700"
                                    style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Combatants Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="combatantsGrid">
                            <!-- Cards Injected via JS -->
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 text-center animate-pulse">
                                <div class="h-4 bg-gray-700 rounded w-1/2 mx-auto mb-2"></div>
                                <div class="h-8 bg-gray-700 rounded w-1/3 mx-auto"></div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Automated Rotation Feedback -->
                                <div
                                    class="bg-gray-700/50 rounded-xl p-4 flex items-center justify-center border border-gray-600 text-center">
                                    <div>
                                        <span
                                            class="block text-xs font-bold text-gray-400 uppercase tracking-widest">Rotation
                                            Status</span>
                                        <p id="rotationFeedback" class="text-green-400 font-mono text-sm mt-1">System:
                                            Auto-Rotation Active</p>
                                    </div>
                                </div>

                                <button id="startTimerBtn"
                                    class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg flex flex-col items-center justify-center transition transform active:scale-95">
                                    <span class="text-lg flex items-center">‚è±Ô∏è START TIMER</span>
                                    <span class="text-xs font-normal opacity-75">Syncs Scoreboard & Judges</span>
                                </button>
                                <button id="nextDisciplineBtn"
                                    class="col-span-1 md:col-span-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center transition transform active:scale-95">
                                    <span class="text-lg mr-2">‚è©</span> NEXT DISCIPLINE
                                </button>
                            </div>
                        </div>

                        <!-- Match Management -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl mt-6">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Danger Zone</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <button id="finishMatchBtn"
                                    class="bg-gray-700 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center transition transform active:scale-95 border border-gray-600 hover:border-green-500 group">
                                    <span class="mr-2 group-hover:scale-110 transition-transform">üèÅ</span> FINISH MATCH
                                </button>
                                <button id="deleteMatchBtn"
                                    class="bg-red-900/30 hover:bg-red-700 text-red-200 hover:text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center transition transform active:scale-95 border border-red-900 border-dashed">
                                    <span class="mr-2">üóëÔ∏è</span> DELETE PERMANENTLY
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>

        </main>

        <script>
            // --- 0. INIT & CONFIG CHECK ---
            if (!CONFIG || CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                document.body.innerHTML = '<div class="h-screen w-screen flex items-center justify-center text-white bg-red-900"><h1>ERROR: Please configure config.js</h1></div>';
                throw new Error("Supabase config not set.");
            }

            const sbClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

            // --- DOM REFERENCE ---
            const $ = (id) => document.getElementById(id);

            let activeMatchId = null;
            let activeDisciplineCode = null;
            let pollInterval = null; // Global poll reference
            const MAO_A = ['SRSS', 'SRDU', 'SRSE', 'DDSR', 'SROF', 'SRCC', 'LMS', 'DDS', 'SRSR'];
            const MAO_B = ['SROF', 'SRCC', 'LMS', 'DDS', 'SRSR', 'SRSS', 'SRDU', 'SRSE', 'DDSR'];

            // --- AUTH & ROLE STATE ---
            let currentUserRole = null;
            let assignedStateId = null;

            // --- 1. DATA FETCHING ---
            async function initAdmin() {
                try {
                    const loader = document.getElementById('app-loader');
                    const dashboard = document.getElementById('viewDashboard');

                    // 1. GATEKEEPER: Session Check
                    const { data: { session } } = await sbClient.auth.getSession();
                    if (!session) {
                        window.location.href = 'index.html';
                        return;
                    }

                    // 2. GATEKEEPER: Role Check
                    const { data: profile, error } = await sbClient.from('admin_profiles').select('*').eq('id', session.user.id).single();
                    if (error || !profile) {
                        console.error("Auth Fail:", error);
                        await sbClient.auth.signOut();
                        window.location.href = 'index.html';
                        return;
                    }

                    currentUserRole = profile.role;
                    assignedStateId = profile.assigned_state_id;

                    // 3. STRICT REDIRECT
                    if (currentUserRole === 'station_judge') {
                        window.location.href = 'judge.html';
                        return;
                    }

                    // 4. GHOST PREVENTION
                    sessionStorage.removeItem('active_match_id');

                    // 5. UNLOCK UI
                    if (loader) loader.style.display = 'none';
                    if (dashboard) dashboard.classList.remove('hidden');

                    // 6. SETUP & POLL
                    $('userRoleDisplay').textContent = currentUserRole.replace('_', ' ');
                    checkAccessControl();
                    updateDashboardStats();

                    // Start Polling ONLY if Chief Judge and NOT ghosting
                    if (currentUserRole === 'chief_judge') {
                        pollLiveMatch();
                        // Clear any existing just in case
                        if (pollInterval) clearInterval(pollInterval);
                        pollInterval = setInterval(pollLiveMatch, 2000);
                    }

                } catch (err) {
                    console.error("Init Critical Error:", err);
                    // allow retry or stuck?
                }
            }


            // --- 2. VIEW CONTROLLER (SPA) ---
            window.switchView = function (viewName) {
                console.log("Switching to:", viewName);

                // 1. Hide ALL views
                document.querySelectorAll('.admin-view').forEach(el => {
                    el.style.display = 'none';
                });

                // 2. Show the TARGET view
                const targetId = `view-${viewName}`;
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.style.display = 'block';
                } else {
                    console.error(`View ID ${targetId} not found!`);
                    return;
                }

                // 3. Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('bg-blue-600', 'text-white');
                    el.classList.add('text-gray-400', 'hover:bg-gray-700', 'hover:text-white');
                });

                const navEl = document.getElementById(`nav-${viewName}`);
                if (navEl) {
                    navEl.classList.remove('text-gray-400', 'hover:bg-gray-700');
                    navEl.classList.add('bg-blue-600', 'text-white');
                }

                // 4. TRIGGER DATA FETCH
                if (viewName === 'states') fetchAndRenderStates();
                if (viewName === 'schools') fetchAndRenderSchools(assignedStateId);
                if (viewName === 'users') fetchAndRenderUsers();
                if (viewName === 'dashboard') updateDashboardStats();
            };

            function checkAccessControl() {
                // STRICT SEPARATION:
                // Super Admin / State Admin = INFRASTRUCTURE (State, School, User) | NO MATCH SETUP, NO LIVE CONTROL
                // Chief Judge = EXECUTION (Match Setup, Live Control) | NO INFRASTRUCTURE

                const navStates = $('nav-states');
                const navSchools = $('nav-schools');
                const navUsers = $('nav-users');
                const navMatch = $('nav-match');

                // 1. Reset Nav/View Visibility (Handled by switchView usually, but we need to hide nav items)
                if (navStates) navStates.classList.add('hidden');
                if (navSchools) navSchools.classList.add('hidden');
                if (navUsers) navUsers.classList.add('hidden');
                if (navMatch) navMatch.classList.add('hidden');

                // 2. Apply Rules
                if (currentUserRole === 'super_admin' || currentUserRole === 'state_admin') {
                    // Show Infrastructure Navs
                    if (navStates) navStates.classList.remove('hidden');
                    if (navSchools) navSchools.classList.remove('hidden');

                    if (currentUserRole === 'super_admin') {
                        if (navUsers) navUsers.classList.remove('hidden');
                    }

                    if (currentUserRole === 'state_admin') {
                        $('stateForm').parentElement.classList.add('hidden');
                    }

                    // Default View
                    switchView('dashboard');

                } else if (currentUserRole === 'chief_judge') {
                    // Show Match Nav
                    if (navMatch) navMatch.classList.remove('hidden');

                    // Default View: Match Setup
                    switchView('match');
                    fetchStatesDropdownsOnly(); // This function is responsible for populating the matchStateSelect dropdown.
                    // The user's instruction to add `loadMatchStates()` here implies a function that might
                    // do more than just populate the dropdown, but based on the existing code,
                    // `fetchStatesDropdownsOnly()` already serves this purpose for the match setup.
                    // To faithfully apply the instruction, I will add `loadMatchStates()` if it's defined elsewhere,
                    // or assume `fetchStatesDropdownsOnly()` is the intended function.
                    // Given the instruction's context, it seems `fetchStatesDropdownsOnly` is the equivalent.
                    // I will add a placeholder comment if `loadMatchStates` is not defined.
                    // If `loadMatchStates` is a new function, it needs to be defined.
                    // For now, I'll assume the user meant to call `fetchStatesDropdownsOnly()` or a similar function.
                    // Since the instruction explicitly says "ADD THIS", I will add the call.
                    // If `loadMatchStates` is not defined, this will cause a runtime error.
                    // However, the instruction is to add it, so I will.
                    // If `loadMatchStates` is meant to replace `fetchStatesDropdownsOnly`, the instruction is ambiguous.
                    // I will add it *after* `fetchStatesDropdownsOnly()` to be safe, or if it's a typo,
                    // I'll assume it's a new function.
                    // Re-reading the instruction: "loadMatchStates() inside the initAdmin function (specifically if role is Chief Judge or Super Admin)."
                    // The provided snippet for the change is:
                    // `loadMatchStates(); // <--- ADDED THIS`
                    // `}    switchView('match');`
                    // This implies `loadMatchStates()` is intended to be called.
                    // The `fetchStatesDropdownsOnly()` is already there.
                    // I will add `loadMatchStates()` as a separate call.
                    // If `loadMatchStates` is not defined in the provided document, this will be a new function call.
                    // I will add it as requested.
                    // Since `fetchStatesDropdownsOnly()` is already present and likely serves the purpose of loading states for dropdowns,
                    // I will add `loadMatchStates()` right after it, assuming it's a distinct, new function the user intends to add.
                    // However, the instruction snippet shows `fetchStatesDropdownsOnly()` *after* the closing brace of the `if` block, which is a syntax error.
                    // The correct place to add it is within the `chief_judge` block.
                    // I will add `loadMatchStates();` right after `fetchStatesDropdownsOnly();` within the `chief_judge` block.
                    loadMatchStates();

                } else if (currentUserRole === 'station_judge') {
                    showToast("Please use the Judge Interface", 'info');
                    setTimeout(() => window.location.href = 'judge.html', 2000);
                } else {
                    showToast("Unauthorized Role", 'error');
                }
            }

            async function updateDashboardStats() {
                // 1. Total States
                const { count: stateCount } = await sbClient.from('states').select('*', { count: 'exact', head: true });
                const statMatch = $('stat-active-match'); // Reuse element ID or rename
                if (statMatch) {
                    statMatch.previousElementSibling.querySelector('h3').textContent = 'Total States';
                    statMatch.previousElementSibling.querySelector('span').textContent = 'ZONES';
                    statMatch.textContent = stateCount || 0;
                    statMatch.classList.remove('text-green-400');
                }

                // 2. Schools Count
                const { count: schoolCount } = await sbClient.from('schools').select('*', { count: 'exact', head: true });
                $('stat-total-schools').textContent = schoolCount || 0;

                // 3. User Count (Admin Profiles)
                const { count: userCount } = await sbClient.from('admin_profiles').select('*', { count: 'exact', head: true });
                $('stat-total-users').textContent = userCount || 0;
            }

            // --- DATA LIST RENDERERS ---

            // 1. STATES
            async function fetchAndRenderStates() {
                const { data, error } = await sbClient.from('states').select('*').order('name');
                if (error || !data) {
                    console.error('Error fetching states', error);
                    return;
                }

                // Populate Dropdowns
                const html = '<option value="">Select State</option>' + data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const schoolSelect = $('schoolStateSelect');
                const matchSelect = $('matchStateSelect');
                const userSelect = $('newUserState');

                if (schoolSelect) schoolSelect.innerHTML = html;
                if (matchSelect) matchSelect.innerHTML = html;
                if (userSelect) userSelect.innerHTML = '<option value="0">None (Global)</option>' + data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                // Render Table (Super Admin Only really cares about editing states)
                const list = $('stateList');
                if (list) {
                    if (data.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No states found.</p>';
                    } else {
                        list.innerHTML = `
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-700 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-2">ID</th>
                                        <th class="px-4 py-2">Name</th>
                                        <th class="px-4 py-2">Zone</th>
                                        <th class="px-4 py-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    ${data.map(s => `
                                        <tr class="hover:bg-gray-700/50 transition">
                                            <td class="px-4 py-2 font-mono text-gray-500">${s.id}</td>
                                            <td class="px-4 py-2 font-bold text-white">${s.name}</td>
                                            <td class="px-4 py-2 text-blue-400">${s.zone_name || '-'}</td>
                                            <td class="px-4 py-2 text-right">
                                                <button onclick="deleteState(${s.id})" class="text-red-400 hover:text-red-300 transition" title="Delete">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                }
            }

            async function fetchStatesDropdownsOnly() {
                // For Chief Judge who doesn't see the list
                const { data } = await sbClient.from('states').select('*').order('name');
                if (data) {
                    const html = '<option value="">Select State</option>' + data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    $('matchStateSelect').innerHTML = html;
                }
            }

            async function deleteState(id) {
                if (!confirm("Are you sure? This will delete the state and ALL associated schools.")) return;
                const { error } = await sbClient.from('states').delete().eq('id', id);
                if (error) showToast(error.message, 'error');
                else {
                    showToast('State deleted');
                    fetchAndRenderStates();
                }
            }

            // 2. SCHOOLS
            // 2. SCHOOLS
            async function fetchAndRenderSchools(stateId = null) {
                let query = sbClient.from('schools').select('*, states(name)').order('name');

                // If State Admin, restrict
                if (currentUserRole === 'state_admin' && stateId) {
                    query = query.eq('state_id', stateId);
                }

                const { data, error } = await query;
                if (error) return;

                // Update Dropdowns for Match Setup
                if ($('school2_1')) {
                    const html = '<option value="">Select School</option>' + data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    $('school2_1').innerHTML = html;
                    $('school2_2').innerHTML = html;
                    $('school2_3').innerHTML = html;
                }

                const list = $('schoolList');
                if (list) {
                    if (data.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No schools found.</p>';
                    } else {
                        list.innerHTML = `
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-700 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-2">Logo</th>
                                        <th class="px-4 py-2">School Name</th>
                                        <th class="px-4 py-2">State</th>
                                        <th class="px-4 py-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700 h-64 overflow-y-auto">
                                    ${data.map(s => `
                                        <tr class="hover:bg-gray-700/50 transition">
                                            <td class="px-4 py-2">
                                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs overflow-hidden">
                                                    ${s.logo_url ? `<img src="${s.logo_url}" class="w-full h-full object-cover">` : 'üè´'}
                                                </div>
                                            </td>
                                            <td class="px-4 py-2 font-medium text-white">${s.name}</td>
                                            <td class="px-4 py-2 text-gray-400">${s.states?.name || 'Unknown'}</td>
                                            <td class="px-4 py-2 text-right space-x-2">
                                                <button onclick="editSchool(${s.id}, '${s.name.replace(/'/g, "\\'")}', ${s.state_id})" class="text-blue-400 hover:text-blue-300 transition" title="Edit">‚úèÔ∏è</button>
                                                <button onclick="deleteSchool(${s.id})" class="text-red-400 hover:text-red-300 transition" title="Delete">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                }
            }

            // Expose Edit Function
            window.editSchool = function (id, name, stateId) {
                // 1. Scroll and Focus
                document.getElementById('view-schools').scrollIntoView({ behavior: 'smooth' });

                // 2. Populate
                $('editSchoolId').value = id;
                $('schoolName').value = name;
                $('schoolStateSelect').value = stateId;

                // 3. UI Changes
                $('schoolFormTitle').textContent = "EDIT SCHOOL";
                $('schoolSubmitBtn').textContent = "UPDATE SCHOOL";
                $('schoolSubmitBtn').classList.remove('bg-green-600', 'hover:bg-green-500');
                $('schoolSubmitBtn').classList.add('bg-blue-600', 'hover:bg-blue-500');

                $('cancelEditBtn').classList.remove('hidden');
            };

            window.cancelSchoolEdit = function () {
                $('schoolForm').reset();
                $('editSchoolId').value = '';

                $('schoolFormTitle').textContent = "ADD NEW SCHOOL";
                $('schoolSubmitBtn').textContent = "ADD SCHOOL";

                $('schoolSubmitBtn').classList.add('bg-green-600', 'hover:bg-green-500');
                $('schoolSubmitBtn').classList.remove('bg-blue-600', 'hover:bg-blue-500');

                $('cancelEditBtn').classList.add('hidden');
            };

            async function deleteSchool(id) {
                if (!confirm("Delete this school?")) return;
                const { error } = await sbClient.from('schools').delete().eq('id', id);
                if (error) showToast(error.message, 'error');
                else {
                    showToast('School deleted');
                    fetchAndRenderSchools(assignedStateId);
                }
            }

            // 3. USERS
            async function fetchAndRenderUsers() {
                // Warning: 'admin_profiles' does not have email. Only Auth has email.
                // But we can't fetch Auth users from client side easily without a function.
                // However, we can check if 'admin_profiles' has an email column?
                // Let's assume for this task we might not have email in 'admin_profiles' unless we added it.
                // The prompt says "Query the profiles (or admin_profiles) table".
                // We should check if we can join or if we stored email.
                // If not, we just show ID and Role.
                // Wait, in previous steps we might have not added email to admin_profiles.
                // Let's just show Role and Assigned State.

                const { data, error } = await sbClient.from('admin_profiles').select('*, states(name)'); // Join states if possible, but structure might differ.
                // Actually 'assigned_state_id' is int, foreign key to states?

                if (error) return;

                const list = $('userList');
                if (list) {
                    if (!data || data.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No users found.</p>';
                    } else {
                        // We'll Fetch emails if we can specific to the user, but we can't lists...
                        // We will display ID (shortened) and Role.
                        list.innerHTML = `
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-700 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-2">User ID</th>
                                        <th class="px-4 py-2">Role</th>
                                        <th class="px-4 py-2">Assigned</th>
                                        <th class="px-4 py-2 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    ${data.map(u => `
                                        <tr class="hover:bg-gray-700/50 transition">
                                            <td class="px-4 py-2 font-mono text-gray-500 text-xs">${u.id.substring(0, 8)}...</td>
                                            <td class="px-4 py-2 font-bold text-white uppercase text-xs">${u.role.replace('_', ' ')}</td>
                                            <td class="px-4 py-2 text-blue-400">${u.assigned_state_id ? ('State #' + u.assigned_state_id) : 'Global'}</td>
                                            <td class="px-4 py-2 text-right">
                                                <button onclick="deleteUser('${u.id}')" class="text-red-400 hover:text-red-300 transition" title="Delete">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                }
            }

            async function deleteUser(id) {
                if (!confirm("Delete this user profile? Note: This does not delete the Auth account, only the Profile access.")) return;
                const { error } = await sbClient.from('admin_profiles').delete().eq('id', id);
                if (error) showToast(error.message, 'error');
                else {
                    showToast('User profile removed');
                    fetchAndRenderUsers();
                }
            }

            // --- TOAST SYSTEM ---
            function showToast(message, type = 'success') {
                const container = $('toastContainer');
                const toast = document.createElement('div');

                // Colors
                const colors = type === 'success'
                    ? 'bg-green-600/90 border-green-500 text-white'
                    : 'bg-red-600/90 border-red-500 text-white';

                const icon = type === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

                toast.className = `pointer-events-auto flex items-center shadow-2xl border-l-4 rounded-r-lg px-6 py-4 min-w-[300px] transform transition-all duration-500 translate-x-full opacity-0 ${colors}`;
                toast.innerHTML = `
                <span class="text-xl mr-3">${icon}</span>
                <div class="flex-1">
                    <p class="font-bold text-sm uppercase tracking-wide">${type}</p>
                    <p class="text-sm font-medium">${message}</p>
                </div>
            `;

                container.appendChild(toast);

                // Animate In
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                });

                // Auto Dismiss
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            }

            // --- 2. EVENT LISTENERS ---

            $('stateForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { error } = await sbClient.from('states').insert([{
                    name: $('stateName').value,
                    zone_name: $('stateZone').value
                }]);

                if (error) showToast(error.message, 'error');
                else {
                    showToast('State added successfully!');
                    $('stateForm').reset();
                    fetchAndRenderStates();
                }
            });

            // ADD / EDIT SCHOOL
            $('schoolForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                // Logic for State Admin: Use assigned variable if role is state_admin
                const selectedState = (currentUserRole === 'state_admin') ? assignedStateId : $('schoolStateSelect').value;
                const schoolName = $('schoolName').value;
                const editId = $('editSchoolId').value;

                if (editId) {
                    // UPDATE
                    const { error } = await sbClient
                        .from('schools')
                        .update({ name: schoolName, state_id: selectedState })
                        .eq('id', editId);

                    if (error) showToast(error.message, 'error');
                    else {
                        showToast('School updated successfully!');
                        cancelSchoolEdit(); // Reset form and mode
                        if (currentUserRole === 'state_admin') fetchAndRenderSchools(assignedStateId);
                        else fetchAndRenderSchools();
                    }

                } else {
                    // INSERT
                    const { error } = await sbClient.from('schools').insert([{
                        name: schoolName,
                        state_id: selectedState
                    }]);

                    if (error) showToast(error.message, 'error');
                    else {
                        showToast('School added successfully!');
                        $('schoolForm').reset();
                        // No need to reset mode as we weren't valid editing, but good practice if we want to be safe
                        // cancelSchoolEdit(); 
                        if (currentUserRole === 'state_admin') fetchAndRenderSchools(assignedStateId);
                        else fetchAndRenderSchools();
                    }
                }
            });

            // CREATE USER (Super Admin)
            $('userForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = $('newUserEmail').value;
                const password = $('newUserPass').value;
                const role = $('newUserRole').value;
                const stateId = $('newUserState').value;

                // Basic Validation
                if (['state_admin', 'state_judge'].includes(role) && (!stateId || stateId === "0")) {
                    showToast("Please select a state for this role.", 'error');
                    return;
                }

                showToast('Creating user...', 'success');

                // 1. Create Auth User
                // NOTE: This might sign in the new user immediately in some client configurations.
                const { data: authData, error: authError } = await sbClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { temp_role: role } // Optional metadata
                    }
                });

                if (authError) {
                    showToast(authError.message, 'error');
                    return;
                }

                const newUserId = authData.user?.id;
                if (!newUserId) {
                    showToast("User created but ID missing.", 'error');
                    return;
                }

                // 2. Create Profile Link
                const profilePayload = {
                    id: newUserId,
                    role: role,
                    assigned_state_id: (stateId && stateId !== "0") ? parseInt(stateId) : null
                };

                const { error: profileError } = await sbClient.from('admin_profiles').insert([profilePayload]);

                if (profileError) {
                    showToast('Auth created but Profile failed: ' + profileError.message, 'error');
                } else {
                    showToast('User created successfully!');
                    $('userForm').reset();
                    fetchAndRenderUsers();
                }
            });

            // --- CASCADING DROPDOWNS ---

            // 1. Load States on Startup
            async function loadMatchStates() {
                const { data: states, error } = await sbClient
                    .from('states')
                    .select('id, name')
                    .order('name');

                if (error) {
                    console.error("Error loading states:", error);
                    return;
                }

                const select = document.getElementById('matchStateSelect');
                if (select) {
                    select.innerHTML = '<option value="">Select State</option>';
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.id;
                        option.textContent = state.name;
                        select.appendChild(option);
                    });
                }
            }

            // 2. Handle State Change -> Load Schools
            const matchStateSelect = document.getElementById('matchStateSelect');
            if (matchStateSelect) {
                matchStateSelect.addEventListener('change', async (e) => {
                    const stateId = e.target.value;
                    if (!stateId) return;

                    // Fetch Schools (Fetch UUIDs too)
                    const { data: schools, error } = await sbClient
                        .from('schools')
                        .select('*')
                        .eq('state_id', stateId)
                        .order('name');

                    if (error) {
                        showToast("Error loading schools!", 'error');
                        console.error(error);
                        return;
                    }

                    // Populate Dropdowns
                    populateSchoolSelect('school2_1', schools);
                    populateSchoolSelect('school2_2', schools);
                    populateSchoolSelect('school2_3', schools);
                });
            }

            // Helper
            function populateSchoolSelect(elementId, schools) {
                const select = document.getElementById(elementId);
                if (!select) return;

                select.innerHTML = '<option value="">Select School</option>';
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    select.appendChild(option);
                });
            }

            $('matchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Initializing Match...");

                const s1 = $('school2_1').value; // UUID
                const s2 = $('school2_2').value; // UUID
                const s3 = $('school2_3').value; // UUID

                console.log("Team 1 ID:", s1);
                console.log("Team 2 ID:", s2);
                console.log("Team 3 ID:", s3);

                const matchName = $('matchName').value;
                const maoOption = $('maoOption').value;

                if (!s1 || !s2 || !s3) {
                    showToast("Please select all 3 teams.", 'error');
                    return;
                }
                if (s1 === s2 || s1 === s3 || s2 === s3) {
                    showToast("Please select 3 different schools.", 'error');
                    return;
                }

                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = "Initializing...";

                try {
                    // 1. Insert Match
                    console.log("Creating Match Entry...");
                    // Need Active Discipline ID? 
                    // Logic from previous code: fetch discipline ID based on MAO.
                    // User prompt didn't explicitly ask for this fetch, but we need `active_discipline_id` for the schema usually.
                    // I will keep the fetch logic for safety or just insert null if allowed?
                    // Previous code fetched it. I should preserve that.

                    const firstCode = (maoOption === 'A') ? MAO_A[0] : MAO_B[0];
                    const { data: discData, error: dErr } = await sbClient.from('disciplines').select('id').eq('code', firstCode).single();
                    if (dErr) throw new Error("Discipline Fetch Failed: " + dErr.message);

                    const { data: match, error: mErr } = await sbClient.from('matches').insert([{
                        match_name: matchName,
                        status: 'active', // User requested 'active'
                        mao_option: maoOption,
                        active_discipline_id: discData.id,
                        created_at: new Date().toISOString()
                    }]).select().single();

                    if (mErr) throw new Error("Match Insert Failed: " + mErr.message);
                    console.log("Match Created:", match);

                    // 2. Insert Teams
                    console.log("Inserting Teams...");
                    // Schema: match_id, team_id, station_assignment
                    const teamsPayload = [
                        { match_id: match.id, team_id: s1, station_assignment: "1" },
                        { match_id: match.id, team_id: s2, station_assignment: "2" },
                        { match_id: match.id, team_id: s3, station_assignment: "3" }
                    ];

                    const { error: tErr } = await sbClient.from('match_teams').insert(teamsPayload);

                    if (tErr) throw new Error("Team Insert Failed: " + tErr.message);

                    // 3. Success
                    alert("Match Initialized Successfully!");
                    window.location.reload(); // Refresh as requested

                } catch (err) {
                    console.error("Initialization Error:", err);
                    showToast(err.message, 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });



            // TIMER LOGIC
            $('startTimerBtn').addEventListener('click', async () => {
                if (!activeMatchId) return;
                const btn = $('startTimerBtn');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    // Update Match with Timer Start
                    const { error } = await sbClient.from('matches').update({
                        timer_status: 'running',
                        start_time: new Date().toISOString()
                    }).eq('id', activeMatchId);

                    if (error) throw error;

                    showToast("Timer Started! ‚è±Ô∏è");
                    await pollLiveMatch();

                } catch (err) {
                    showToast("Timer Error: " + err.message, 'error');
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 2000);
                }
            });

            // NEXT DISCIPLINE LOGIC
            $('nextDisciplineBtn').addEventListener('click', async () => {
                if (!activeMatchId || !activeMAO || !activeDisciplineCode) return;

                if (!confirm(`Advance from ${activeDisciplineCode}? This will clear current locks.`)) return;

                const seq = (activeMAO === 'A') ? MAO_A : MAO_B;
                const currentIndex = seq.indexOf(activeDisciplineCode);

                if (currentIndex === -1 || currentIndex === seq.length - 1) {
                    showToast("Match Complete! Proceed to Tug of War Setup.");
                    return;
                }

                const nextCode = seq[currentIndex + 1];

                // Get ID
                const { data: disc, error } = await sbClient.from('disciplines').select('id').eq('code', nextCode).single();
                if (error) { showToast("Error fetching next discipline", 'error'); return; }

                // Update Match
                await sbClient.from('matches').update({ active_discipline_id: disc.id }).eq('id', activeMatchId);

                // Clear Locks
                await sbClient.from('station_assignments').delete().eq('match_id', activeMatchId);

                await pollLiveMatch();
                showToast(`Advanced to ${nextCode}`);
            });

            // FINISH MATCH LOGIC
            // FINISH MATCH LOGIC
            $('finishMatchBtn').addEventListener('click', async () => {
                // Kill Interval FIRST
                if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }

                if (!activeMatchId) return;
                if (!confirm("Are you sure you want to FINISH this match? It will be archived.")) {
                    pollInterval = setInterval(pollLiveMatch, 2000);
                    return;
                }

                // SHOW LOADER
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.querySelector('h2').textContent = "FINISHING MATCH...";
                    loader.style.display = 'flex';
                }

                const btn = $('finishMatchBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = "Finishing...";

                try {
                    const { error } = await sbClient.from('matches')
                        .update({ status: 'finished', timer_status: 'stopped' })
                        .eq('id', activeMatchId);

                    if (error) throw error;

                    // TASK 3: Clean Finish
                    if (pollInterval) clearInterval(pollInterval);
                    activeMatchId = null;
                    localStorage.removeItem('active_match_id');

                    showToast("Match Finished! üèÅ");

                    // Reset UI
                    showNoLiveMatch();

                    setTimeout(() => window.location.reload(), 1500);

                } catch (err) {
                    showToast("Error: " + err.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });

            // DELETE MATCH LOGIC
            // DELETE MATCH LOGIC
            $('deleteMatchBtn').addEventListener('click', async () => {
                // Kill Interval FIRST
                if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }

                if (!activeMatchId) return;
                if (!confirm("Are you sure? This will PERMANENTLY DELETE the match and ALL SCORES. This cannot be undone.")) {
                    pollInterval = setInterval(pollLiveMatch, 2000);
                    return;
                }

                // SHOW LOADER
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.querySelector('h2').textContent = "PERFORMING CLEANUP...";
                    loader.style.display = 'flex';
                }

                const btn = $('deleteMatchBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = "Deleting...";

                try {
                    // 1. Delete Dependencies (Cascade)
                    await sbClient.from('scores').delete().eq('match_id', activeMatchId);
                    await sbClient.from('station_assignments').delete().eq('match_id', activeMatchId);
                    await sbClient.from('match_teams').delete().eq('match_id', activeMatchId);

                    // 2. Delete Match (Verify)
                    const { count, error } = await sbClient
                        .from('matches')
                        .delete({ count: 'exact' })
                        .eq('id', activeMatchId);

                    if (error) throw error;

                    if (count === 0) {
                        console.warn("Hard Delete returned 0. Attempting Soft Delete/Archive...");
                        // Fallback: Archive it
                        await sbClient.from('matches').update({ status: 'archived' }).eq('id', activeMatchId);
                    } else {
                        console.log(`Deleted ${count} matches.`);
                    }

                    // TASK 1: Kill Polling
                    if (pollInterval) clearInterval(pollInterval);
                    activeMatchId = null;

                    showToast("Match Deleted.");
                    localStorage.removeItem('active_match_id');

                    // Reset UI immediately
                    showNoLiveMatch();

                    setTimeout(() => window.location.reload(), 1500);

                } catch (err) {
                    showToast("Error: " + err.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });


            // --- 3. LIVE MONITORING ---
            // HELPER: Defensive DOM Update
            function updateTextSafe(id, text) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = text;
                    if (id === 'activeMatchLabel') {
                        // Specific styling for this badge if it exists
                    }
                }
                return el; // return element in case we want to do more
            }

            // --- 3. LIVE MONITORING & CONTROL ---
            async function pollLiveMatch() {
                if (currentUserRole !== 'chief_judge') return;

                try {
                    // 1. Fetch Deep Data + Count check
                    const { count, error: countError } = await sbClient
                        .from('matches')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'active');

                    if (countError) {
                        console.error("LIVE POLL COUNT ERROR:", countError);
                        return;
                    }

                    const lbl = document.getElementById('activeMatchLabel');
                    if (count > 1) {
                        // Warn about duplicates
                        if (lbl) {
                            lbl.textContent = `LIVE (${count} ACTIVE MATCHES)`;
                            lbl.classList.add('bg-red-500', 'animate-pulse');
                        }
                    } else {
                        // Ensure the label is reset if there's 0 or 1 active match
                        if (lbl) {
                            lbl.classList.remove('bg-red-500', 'animate-pulse');
                            // Text content will be set later by showNoLiveMatch or by the match data
                        }
                    }

                    const { data: match, error } = await sbClient
                        .from('matches')
                        .select(`
                            id, status, timer_status, start_time, active_discipline_id, match_name, mao_option, created_at,
                            disciplines(code, name),
                            match_teams(
                                id, 
                                station_assignment, 
                                team_id, 
                                schools:team_id(name) 
                            ),
                            scores(
                                score_points, 
                                school_id, 
                                active_discipline_id
                            )
                        `)
                        .eq('status', 'active')
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .maybeSingle();

                    if (error) {
                        console.error("LIVE POLL ERROR:", error);
                        console.log("Detailed Error:", error.message, error.details, error.hint);
                        return;
                    }

                    const setupCard = document.getElementById('matchSetupCard');
                    const livePanel = document.getElementById('liveControlPanel');

                    if (!match) {
                        // NO ACTIVE MATCH -> SHOW SETUP
                        if (setupCard) setupCard.classList.remove('hidden');
                        if (livePanel) livePanel.classList.add('hidden');

                        // Ensure we don't think we have one
                        activeMatchId = null;
                        return;
                    }

                    // ACTIVE MATCH -> SHOW LIVE PANEL
                    if (setupCard) setupCard.classList.add('hidden');
                    if (livePanel) livePanel.classList.remove('hidden');

                    activeMatchId = match.id;
                    activeMAO = match.mao_option;
                    activeDisciplineCode = match.disciplines?.code;

                    // 2. Update Header & Time
                    document.getElementById('liveMatchTitle').innerHTML = `${match.match_name} <span class="text-xs text-gray-500 block font-mono mt-1">${match.id.slice(0, 8)}...</span>`;
                    document.getElementById('activeDisciplineName').textContent = match.disciplines?.name || 'Unknown';

                    if (match.start_time) {
                        const start = new Date(match.start_time).getTime();
                        const now = new Date().getTime();
                        const diff = Math.floor((now - start) / 1000);
                        const mm = Math.floor(diff / 60).toString().padStart(2, '0');
                        const ss = (diff % 60).toString().padStart(2, '0');
                        document.getElementById('timeElapsed').textContent = `${mm}:${ss}`;
                    }

                    // 3. Update Progress Bar
                    // Count unique active_discipline_id in scores to see how many played
                    // Plus 1 for current if not yet scored?
                    // Actually, simple logic: count unique completed disciplines.
                    // Or just use index in MAO sequence if we knew it.
                    // User suggested: `new Set(match.scores.map(s => s.active_discipline_id)).size`.
                    // This counts disciplines that have at least one score recorded.
                    const uniqueDisciplines = new Set(match.scores.map(s => s.active_discipline_id)).size;
                    // Current one is "in progress", so maybe +1? 
                    // Let's stick to user request: "Discipline X of 9".
                    // If unique is 0, we are on 1. If unique is 1 (completed 1), we are on 2.
                    // Basically: (Count + 1). Max 9.
                    const currentStep = Math.min(uniqueDisciplines + 1, 9);
                    const progressPct = (currentStep / 9) * 100;

                    document.getElementById('progressText').textContent = `Discipline ${currentStep} of 9`;
                    document.getElementById('matchProgressBar').style.width = `${progressPct}%`;

                    const feedbackEl = document.getElementById('rotationFeedback');
                    if (feedbackEl) {
                        feedbackEl.textContent = `Auto-Rotated for ${match.disciplines?.code || 'Discipline'}`;
                        feedbackEl.className = "text-green-400 font-mono text-sm mt-1 animate-pulse";
                    }


                    // 4. Combatants Grid (Dynamic Rotation)
                    const grid = document.getElementById('combatantsGrid');
                    grid.innerHTML = '';

                    // Identify Rotation Index
                    const currentCode = match.disciplines?.code;
                    const maoOpt = match.mao_option || 'A';
                    const seq = (maoOpt === 'A') ? MAO_A : MAO_B;
                    let discIndex = seq.indexOf(currentCode);
                    if (discIndex === -1) discIndex = 0; // Default or fallback

                    // Calculate which BASE team is at each PHYSICAL station
                    const teamsAtStations = [];
                    for (let station = 1; station <= 3; station++) {
                        // Formula: BaseSlot = ((Station - 1 - Index) % 3 + 3) % 3 + 1
                        const baseSlot = ((station - 1 - discIndex) % 3 + 3) % 3 + 1;
                        const team = match.match_teams.find(t => t.station_assignment === baseSlot);
                        teamsAtStations.push(team);
                    }

                    teamsAtStations.forEach((team, index) => {
                        const stationNum = index + 1;
                        if (!team) {
                            grid.innerHTML += `<div class="bg-gray-700/50 p-4 rounded-xl text-center text-gray-500">Empty Station ${stationNum}</div>`;
                            return;
                        }

                        // Calculate TDP (Total Points)
                        const tdp = match.scores
                            .filter(s => String(s.school_id) === String(team.team_id))
                            .reduce((sum, s) => sum + (s.score_points || 0), 0);

                        // Render Card
                        grid.innerHTML += `
                            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 relative overflow-hidden group hover:border-blue-500 transition-colors">
                                <div class="absolute top-0 right-0 bg-gray-700 text-xs font-bold px-2 py-1 rounded-bl-lg text-gray-300">
                                    STATION ${stationNum}
                                </div>
                                <div class="mt-4 mb-2">
                                    <h4 class="text-xl font-bold text-white truncate" title="${team.schools?.name}">
                                        ${team.schools?.name || 'Unknown Team'}
                                    </h4>
                                </div>
                                <div class="flex items-end justify-center space-x-2">
                                    <span class="text-4xl font-black text-blue-400">${tdp}</span>
                                    <span class="text-xs text-blue-400/70 font-bold mb-2">PTS</span>
                                </div>
                            </div>
                        `;
                    });

                } catch (err) {
                    console.error("Live Poll Error:", err);
                }
            }

            function showNoLiveMatch() {
                activeMatchId = null;
                const activeLabel = document.getElementById('activeMatchLabel');
                if (activeLabel) activeLabel.textContent = "NO MATCH";

                const livePanel = document.getElementById('liveControlPanel');
                if (livePanel) livePanel.classList.add('hidden');

                const setCard = document.getElementById('matchSetupCard');
                if (setCard) setCard.classList.remove('hidden');
            }

            function handleResult(elId, error, successMsg) {
                const el = document.getElementById(elId);
                if (error) {
                    el.textContent = "Error: " + error.message;
                    el.className = "mt-3 text-xs text-center text-red-400";
                } else {
                    el.textContent = successMsg;
                    el.className = "mt-3 text-xs text-center text-green-400";
                    setTimeout(() => { el.textContent = ''; }, 3000);
                }
            }

            // --- EMERGENCY RESET ---
            const resetBtn = document.getElementById('emergencyResetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', async () => {
                    // Kill interval
                    if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }

                    const code = prompt("Type 'DELETE' to confirm system wipe:");
                    if (code !== 'DELETE') {
                        pollInterval = setInterval(pollLiveMatch, 2000);
                        return;
                    }

                    // SHOW LOADER
                    const loader = document.getElementById('app-loader');
                    if (loader) {
                        loader.querySelector('h2').textContent = "NUKING SYSTEM...";
                        loader.style.display = 'flex';
                    }


                    resetBtn.disabled = true;
                    resetBtn.textContent = "Wiping...";

                    try {
                        // Delete ALL Data
                        // Note: Supabase requires a WHERE clause usually. 'id.neq.0' covers all valid IDs.
                        await sbClient.from('scores').delete().neq('id', 0);
                        await sbClient.from('station_assignments').delete().neq('id', 0);
                        await sbClient.from('match_teams').delete().neq('id', 0);
                        await sbClient.from('matches').delete().neq('id', 0);

                        showToast("SYSTEM WIPED CLEAN üßπ");
                        setTimeout(() => window.location.reload(), 1000);

                    } catch (err) {
                        alert("Reset Failed: " + err.message);
                        resetBtn.disabled = false;
                        resetBtn.textContent = "‚ö†Ô∏è NUKE SYSTEM";
                    }
                });
            }

            // --- INIT ---
            // fetchStates(); // Removed, handled in initAdmin
            // pollLiveMatch(); // Handled in initAdmin

            // Start Loop
            // Start Loop
            // pollInterval = setInterval(pollLiveMatch, 2000); // MOVED TO INITADMIN

            // --- AUTH HANDLERS ---
            $('logoutBtn').addEventListener('click', async () => {
                await sbClient.auth.signOut();
                window.location.href = 'index.html';
            });

            // INIT
            initAdmin();

        </script>
</body>

</html>