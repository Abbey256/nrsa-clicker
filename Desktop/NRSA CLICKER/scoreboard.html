<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NRSA Scoreboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=JetBrains+Mono:wght@800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #050505;
            color: white;
            overflow: hidden;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .neon-border {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .score-change {
            animation: flash 1s ease-out;
        }

        @keyframes flash {
            0% {
                color: #ffff00;
                transform: scale(1.1);
            }

            100% {
                color: white;
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col justify-center items-center">

    <!-- SPLASH SCREEN (Waiting Mode) -->
    <div id="splashScreen"
        class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black transition-opacity duration-1000">
        <h1 class="text-6xl font-bold text-gray-700 animate-pulse tracking-widest">AWAITING SIGNAL</h1>
        <p class="mt-4 text-gray-500 font-mono">NRSA CHAMPIONSHIP SYSTEM</p>
    </div>

    <!-- MAIN SCOREBOARD -->
    <div id="mainBoard" class="w-full h-full flex flex-col opacity-0 transition-opacity duration-1000 p-8">

        <!-- HEADER -->
        <header class="flex justify-between items-start mb-12 border-b-2 border-gray-800 pb-6 relative">
            <div>
                <h1 class="text-5xl font-bold text-blue-500 neon-text tracking-wider">NRSA CHAMPIONSHIP <span
                        id="yearDisplay">2025</span></h1>
                <div class="flex items-center mt-4 space-x-4">
                    <span
                        class="px-4 py-2 bg-gray-800 rounded-lg text-2xl text-white font-mono border border-gray-600 uppercase tracking-widest"
                        id="disciplineBadge">LOADING...</span>
                    <!-- Status Badge -->
                    <span id="matchStatus"
                        class="hidden px-4 py-2 bg-green-900/50 text-green-400 border border-green-500 rounded-lg font-bold tracking-widest animate-pulse">LIVE</span>
                </div>
            </div>

            <!-- MASSIVE TIMER -->
            <div
                class="bg-gray-900 px-12 py-6 rounded-2xl border-4 border-gray-800 shadow-2xl relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 pointer-events-none"></div>
                <div id="timerDisplay"
                    class="text-9xl font-mono font-black text-white tracking-widest leading-none relative z-10">00:00
                </div>
            </div>
        </header>

        <!-- SCORE GRID -->
        <div class="flex-1 grid grid-cols-3 gap-8 pb-8">

            <!-- Station 1 -->
            <div class="station-card bg-gray-900 rounded-3xl border-2 border-gray-800 p-8 flex flex-col relative overflow-hidden shadow-2xl transition-all duration-500"
                id="card_1">
                <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>
                <div class="flex justify-between items-center mb-8">
                    <span class="text-2xl font-bold text-gray-500 uppercase tracking-widest">Station 1</span>
                    <div id="lock_1"
                        class="w-6 h-6 rounded-full bg-gray-800 border-2 border-gray-700 shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-colors duration-300">
                    </div>
                </div>
                <h2 id="name_1" class="text-4xl font-bold text-white mb-auto truncate leading-tight">Waiting...</h2>
                <div class="text-right mt-8">
                    <span class="block text-2xl text-gray-500 font-mono mb-2 uppercase">Score</span>
                    <span id="score_1"
                        class="text-9xl font-black text-white font-mono leading-none tracking-tighter">0</span>
                </div>
            </div>

            <!-- Station 2 -->
            <div class="station-card bg-gray-900 rounded-3xl border-2 border-gray-800 p-8 flex flex-col relative overflow-hidden shadow-2xl transition-all duration-500"
                id="card_2">
                <div class="absolute top-0 left-0 w-full h-2 bg-yellow-600"></div>
                <div class="flex justify-between items-center mb-8">
                    <span class="text-2xl font-bold text-gray-500 uppercase tracking-widest">Station 2</span>
                    <div id="lock_2"
                        class="w-6 h-6 rounded-full bg-gray-800 border-2 border-gray-700 shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-colors duration-300">
                    </div>
                </div>
                <h2 id="name_2" class="text-4xl font-bold text-white mb-auto truncate leading-tight">Waiting...</h2>
                <div class="text-right mt-8">
                    <span class="block text-2xl text-gray-500 font-mono mb-2 uppercase">Score</span>
                    <span id="score_2"
                        class="text-9xl font-black text-white font-mono leading-none tracking-tighter">0</span>
                </div>
            </div>

            <!-- Station 3 -->
            <div class="station-card bg-gray-900 rounded-3xl border-2 border-gray-800 p-8 flex flex-col relative overflow-hidden shadow-2xl transition-all duration-500"
                id="card_3">
                <div class="absolute top-0 left-0 w-full h-2 bg-red-600"></div>
                <div class="flex justify-between items-center mb-8">
                    <span class="text-2xl font-bold text-gray-500 uppercase tracking-widest">Station 3</span>
                    <div id="lock_3"
                        class="w-6 h-6 rounded-full bg-gray-800 border-2 border-gray-700 shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-colors duration-300">
                    </div>
                </div>
                <h2 id="name_3" class="text-4xl font-bold text-white mb-auto truncate leading-tight">Waiting...</h2>
                <div class="text-right mt-8">
                    <span class="block text-2xl text-gray-500 font-mono mb-2 uppercase">Score</span>
                    <span id="score_3"
                        class="text-9xl font-black text-white font-mono leading-none tracking-tighter">0</span>
                </div>
            </div>

        </div>
    </div>

    <!-- OFFICIAL SHEET (Table Mode) -->
    <div id="officialSheet" class="w-full h-full flex flex-col hidden bg-black p-4 z-40 absolute inset-0">
        <header class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
            <h2 class="text-3xl font-bold text-gray-400 font-mono">OFFICIAL SHEET</h2>
            <div class="text-gray-600 text-sm">PROVISIONAL DATA</div>
        </header>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left border-collapse table-fixed" id="official-sheet-table">
                <thead>
                    <tr class="bg-gray-900 border-b-2 border-gray-700">
                        <!-- Discipline Column (25%) -->
                        <th class="p-4 border-r-2 border-gray-700 font-mono text-xl w-[25%]">DISCIPLINE</th>

                        <!-- Team Headers (25% each) -->
                        <th colspan="2"
                            class="p-2 border-r-2 border-gray-700 text-center text-blue-400 font-bold text-2xl w-[25%]"
                            id="header-team-1">
                            Team A
                        </th>

                        <th colspan="2"
                            class="p-2 border-r-2 border-gray-700 text-center text-yellow-500 font-bold text-2xl w-[25%]"
                            id="header-team-2">
                            Team B
                        </th>

                        <th colspan="2" class="p-2 text-center text-red-500 font-bold text-2xl w-[25%]"
                            id="header-team-3">
                            Team C
                        </th>
                    </tr>

                    <tr class="bg-gray-800 text-sm text-gray-500 font-mono border-b border-gray-700">
                        <th class="border-r-2 border-gray-700"></th>

                        <th class="p-2 text-center border-r border-gray-700 w-1/2">DP</th>
                        <th
                            class="p-2 text-center border-r-2 border-gray-700 text-white font-bold w-1/2 bg-gray-900/50">
                            TDP</th>

                        <th class="p-2 text-center border-r border-gray-700 w-1/2">DP</th>
                        <th
                            class="p-2 text-center border-r-2 border-gray-700 text-white font-bold w-1/2 bg-gray-900/50">
                            TDP</th>

                        <th class="p-2 text-center border-r border-gray-700 w-1/2">DP</th>
                        <th class="p-2 text-center text-white font-bold w-1/2 bg-gray-900/50">TDP</th>
                    </tr>
                </thead>
                <tbody id="sheetBody" class="font-mono text-xl"></tbody>
                <tfoot id="sheetFoot" class="bg-gray-900 text-white font-bold border-t-4 border-gray-700 text-2xl">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        // --- 1. SETUP ---
        if (!CONFIG || !CONFIG.SUPABASE_URL) throw new Error("Missing Config");
        const sbClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const $ = (id) => document.getElementById(id);

        let activeMatchId = null;
        let activeDisciplineId = null;
        let activeDisciplineCode = null; // NEW
        let activeMao = 'A'; // Default to A
        let viewMode = 'main'; // 'main' or 'sheet'

        const MAO_ORDERS = {
            'A': ['SRSS', 'SRDU', 'SRSE', 'DDSR', 'SROF', 'SRCC', 'LMS', 'DDS', 'SRSR'],
            'B': ['SROF', 'SRCC', 'LMS', 'DDS', 'SRSR', 'SRSS', 'SRDU', 'SRSE', 'DDSR']
        };

        const POINT_TABLE = {
            'SRSS': [5, 3, 1], 'SROF': [5, 3, 1], 'SRCC': [5, 3, 1],
            'SRDU': [10, 6, 2], 'LMS': [10, 6, 2], 'SRSE': [10, 6, 2],
            'DDS': [15, 9, 3],
            'SRSR': [20, 12, 4], 'DDSR': [20, 12, 4]
        };

        // Data Store [Station ID 1-3] -> { schoolId, schoolName, totalScore, locked }
        // Physical Scoreboard Cards (Rotates)
        let stations = {
            1: { schoolId: null, name: '---', score: 0, locked: false },
            2: { schoolId: null, name: '---', score: 0, locked: false },
            3: { schoolId: null, name: '---', score: 0, locked: false }
        };

        // Official Sheet Slots (Fixed: Team A, Team B, Team C)
        let baseTeams = {
            1: { schoolId: null, name: 'Vacant' },
            2: { schoolId: null, name: 'Vacant' },
            3: { schoolId: null, name: 'Vacant' }
        };

        // --- 2. INIT ---
        async function initScoreboard() {
            // Find Live Match
            const { data: match, error } = await sbClient
                .from('matches')
                .select('*, disciplines(name, code)')
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (match) {
                activeMatchId = match.id;
                activeDisciplineId = match.active_discipline_id;
                activeDisciplineCode = match.disciplines?.code; // NEW: Store Code
                activeMao = match.mao_option || 'A';

                // UI Wakeup
                $('splashScreen').classList.add('opacity-0', 'pointer-events-none');

                if (viewMode === 'main') $('mainBoard').classList.remove('opacity-0', 'hidden');

                updateHeader(match);
                await fetchTeams();
                await fetchStationLocks();
                await fetchAllScores(); // Initial full calc

                subscribeRealtime();

                // Keyboard Toggle
                document.addEventListener('keydown', (e) => {
                    if (e.key.toLowerCase() === 't') toggleView();
                });

            } else {
                // Show Splash
                $('splashScreen').classList.remove('opacity-0', 'pointer-events-none');
                $('mainBoard').classList.add('opacity-0');
                $('officialSheet').classList.add('hidden');

                // Monitor for new matches
                sbClient.channel('global_match_listener')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'matches', filter: "status=eq.active" }, () => {
                        window.location.reload();
                    })
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches', filter: "status=eq.active" }, () => {
                        initScoreboard(); // Retry init
                    })
                    .subscribe();
            }
        }

        function toggleView() {
            if (viewMode === 'main') {
                viewMode = 'sheet';
                $('mainBoard').classList.add('hidden');
                $('officialSheet').classList.remove('hidden');
                renderOfficialSheet();
            } else {
                viewMode = 'main';
                $('mainBoard').classList.remove('hidden');
                $('officialSheet').classList.add('hidden');
            }
        }

        // --- 3. CORE FUNCTIONS ---

        let timerInterval = null;

        function updateHeader(match) {
            // Dynamic Title
            const titleEl = document.querySelector('h1.text-5xl');
            if (titleEl) {
                // Keep the "NRSA CHAMPIONSHIP" part if match name is short, or replace?
                // Request: Replace "NRSA CHAMPIONSHIP 2026" with actual match name
                // Fallback: "NRSA GRASSROOT MATCH"
                const matchName = match.match_name || "NRSA GRASSROOT MATCH";
                titleEl.innerHTML = `${matchName} <span id="yearDisplay" class="text-3xl opacity-50 block mt-2 text-white">2026</span>`;
            }

            const dName = match.disciplines?.name || 'UNKNOWN';
            const dCode = match.disciplines?.code || '';
            $('disciplineBadge').textContent = `${dName} ${dCode ? '(' + dCode + ')' : ''}`;

            // Sync Timer Init
            if (timerInterval) clearInterval(timerInterval);
            if (match.timer_status === 'running' && match.start_time) {
                startTimerSync(match.start_time, dCode);
            } else {
                $('timerDisplay').textContent = "00:00";
            }
        }

        function startTimerSync(startTimeStr, discCode) {
            const DURATIONS = {
                // 30 Seconds
                'SRSS': 30, 'SRDU': 30, 'SRCC': 30, 'SROF': 30, 'SRSE': 30,
                // 60 Seconds
                'DDS': 60,
                // 120 Seconds
                'SRSR': 120, 'DDSR': 120,
                // LIVE (No countdown)
                'LMS': 0
            };

            const duration = DURATIONS[discCode] || 30; // Default 30s safety

            // Special Case: LMS
            if (duration === 0) {
                $('timerDisplay').textContent = "LIVE";
                return;
            }

            const startTime = new Date(startTimeStr).getTime();
            const beepSound = new Audio('https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3'); // Simple beep

            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const elapsedEx = (now - startTime) / 1000;
                const remaining = Math.max(0, duration - elapsedEx);

                const mm = Math.floor(remaining / 60).toString().padStart(2, '0');
                const ss = Math.floor(remaining % 60).toString().padStart(2, '0');

                // Visual Updates
                const display = $('timerDisplay');
                display.textContent = `${mm}:${ss}`;

                if (remaining <= 10) {
                    display.classList.add('text-red-500', 'animate-pulse');
                } else {
                    display.classList.remove('text-red-500', 'animate-pulse');
                }

                if (remaining <= 0) {
                    display.textContent = "00:00";
                    clearInterval(timerInterval);
                    beepSound.play().catch(e => console.log("Audio play failed:", e));
                }

            }, 200); // Higher freq for smoothness
        }

        async function fetchTeams() {
            const { data } = await sbClient.from('match_teams')
                .select('station_assignment, team_id, schools:team_id(name)')
                .eq('match_id', activeMatchId);

            if (data) {
                // 1. Reset Base Teams
                [1, 2, 3].forEach(i => baseTeams[i].name = "Vacant");

                // 2. Populate Base Teams (Fixed Slots)
                data.forEach(t => {
                    const slot = t.station_assignment;
                    if (baseTeams[slot]) {
                        baseTeams[slot].schoolId = t.team_id;
                        baseTeams[slot].name = t.schools.name || "Unknown";
                    }
                });

                // 3. Map to Physical Stations (Rotation Logic)
                const order = MAO_ORDERS[activeMao || 'A'];
                const discIndex = activeDisciplineId ? order.indexOf(activeDisciplineId) : 0;
                // Fallback if ID is actually the code (unlikely given schema, but safety)
                // If activeDisciplineId is UUID, we need to find it in the list. Wait, fetchActiveMatch fetched JOIN.
                // Re-check fetchActiveMatch in initScoreboard -> it fetches `disciplines(name, code)`.
                // BUT activeDisciplineId is storing the UUID or Code?
                // `activeDisciplineId = match.active_discipline_id;` <-- This is usually UUID (FK).
                // `MAO_ORDERS` has Codes. We need the Code to find Index.
                // Let's fix initScoreboard to store activeDisciplineCode as well.

                // TEMP FIX: Re-calculate index using Code if available, else 0
                const dCode = document.getElementById('disciplineBadge').textContent.split('(')[1]?.replace(')', '') || '';
                // That parsing is risky. Better to store code in variable.

                updateStationsFromBase(discIndex !== -1 ? discIndex : 0);
            }
        }

        function updateStationsFromBase(discIndex) {
            // Formula: PhysicalStation -> BaseSlot
            // BaseSlot = ((Station - 1 - Index) % 3 + 3) % 3 + 1
            // We need: BaseSlot -> PhysicalStation for display?
            // Actually, we iterate Physical Stations 1..3 and ask "Who is here?"

            [1, 2, 3].forEach(stationId => {
                const baseSlot = ((stationId - 1 - discIndex) % 3 + 3) % 3 + 1;
                const team = baseTeams[baseSlot];

                stations[stationId].schoolId = team.schoolId;
                stations[stationId].name = team.name;
                // Score is separate
            });
            renderStations();
        }

        async function fetchStationLocks() {
            const { data } = await sbClient.from('station_assignments')
                .select('station_id')
                .eq('match_id', activeMatchId)
                .eq('status', 'LOCKED');

            // Reset
            [1, 2, 3].forEach(i => stations[i].locked = false);

            if (data) {
                data.forEach(l => {
                    if (stations[l.station_id]) stations[l.station_id].locked = true;
                });
            }
            renderStations();
        }

        async function fetchAllScores() {
            const { data } = await sbClient.from('scores')
                .select('school_id, score_points, discipline_id')
                .eq('match_id', activeMatchId);

            // Calculate Main Board Scores (Active Discipline Only)
            if (!activeDisciplineId) return;

            // Reset stations local score for Main Board
            [1, 2, 3].forEach(i => stations[i].score = 0);

            if (data) {
                data.forEach(row => {
                    if (row.discipline_id === activeDisciplineId) {
                        const sid = row.school_id;
                        [1, 2, 3].forEach(i => {
                            // Compare IDs safely
                            if (String(stations[i].schoolId) === String(sid)) {
                                stations[i].score += row.score_points;
                            }
                        });
                    }
                });
            }
            // Re-render Stations to show updated scores
            renderStations();

            // Official Sheet always calculates everything
            if (viewMode === 'sheet') renderOfficialSheet();
        }

        function renderStations() {
            [1, 2, 3].forEach(i => {
                const st = stations[i];
                $(`name_${i}`).textContent = st.name;

                const scoreEl = $(`score_${i}`);
                const oldVal = parseInt(scoreEl.textContent);
                if (oldVal !== st.score) {
                    scoreEl.textContent = st.score;
                    scoreEl.parentElement.classList.remove('score-change');
                    void scoreEl.parentElement.offsetWidth;
                    scoreEl.parentElement.classList.add('score-change');
                }

                const lockEl = $(`lock_${i}`);
                if (st.locked) {
                    lockEl.classList.add('bg-green-500', 'shadow-[0_0_15px_rgba(34,197,94,0.8)]', 'border-green-400');
                    lockEl.classList.remove('bg-gray-800', 'border-gray-700', 'shadow-[0_0_10px_rgba(0,0,0,0.5)]');
                } else {
                    lockEl.classList.remove('bg-green-500', 'shadow-[0_0_15px_rgba(34,197,94,0.8)]', 'border-green-400');
                    lockEl.classList.add('bg-gray-800', 'border-gray-700', 'shadow-[0_0_10px_rgba(0,0,0,0.5)]');
                }
            });
        }

        // --- 4. OFFICIAL SHEET LOGIC ---
        async function renderOfficialSheet() {
            // 1. Fetch ALL Disciplines
            const { data: disciplines } = await sbClient.from('disciplines').select('*');
            // 2. Fetch ALL Scores for this match
            const { data: scores } = await sbClient.from('scores').select('school_id, score_points, discipline_id').eq('match_id', activeMatchId);

            // Map: DiscID -> SchoolID -> Total
            let map = {};
            if (scores) {
                scores.forEach(s => {
                    const dKey = String(s.discipline_id);
                    const sKey = String(s.school_id);
                    if (!map[dKey]) map[dKey] = {};
                    if (!map[dKey][sKey]) map[dKey][sKey] = 0;
                    map[dKey][sKey] += (s.score_points || 0);
                });
            }

            const teamAId = String(baseTeams[1].schoolId || '');
            const teamBId = String(baseTeams[2].schoolId || '');
            const teamCId = String(baseTeams[3].schoolId || '');

            $('header-team-1').textContent = baseTeams[1].name;
            $('header-team-2').textContent = baseTeams[2].name;
            $('header-team-3').textContent = baseTeams[3].name;

            const tbody = $('sheetBody');
            tbody.innerHTML = "";

            let tdpA = 0, tdpB = 0, tdpC = 0;

            // SORT based on MAO
            let sortedDisciplines = [];
            const order = MAO_ORDERS[activeMao] || MAO_ORDERS['A'];

            if (disciplines) {
                const dMap = disciplines.reduce((acc, d) => { acc[d.code] = d; return acc; }, {});
                order.forEach(code => {
                    if (dMap[code]) sortedDisciplines.push(dMap[code]);
                });
                disciplines.forEach(d => {
                    if (!order.includes(d.code)) sortedDisciplines.push(d);
                });
            }

            if (sortedDisciplines) {
                sortedDisciplines.forEach(d => {
                    const dKey = String(d.id);

                    const hasA = map[dKey] && map[dKey].hasOwnProperty(teamAId);
                    const hasB = map[dKey] && map[dKey].hasOwnProperty(teamBId);
                    const hasC = map[dKey] && map[dKey].hasOwnProperty(teamCId);
                    const anyStarted = hasA || hasB || hasC;

                    const scA = hasA ? map[dKey][teamAId] : 0;
                    const scB = hasB ? map[dKey][teamBId] : 0;
                    const scC = hasC ? map[dKey][teamCId] : 0;

                    let dpA = 0, dpB = 0, dpC = 0;

                    if (anyStarted) {
                        // Rank Points (3-2-1)
                        // NRSA Scoring (Weighted + Ties)
                        const pDist = POINT_TABLE[d.code] || [0, 0, 0];
                        const entries = [
                            { id: 'A', score: scA, idx: 0 },
                            { id: 'B', score: scB, idx: 1 },
                            { id: 'C', score: scC, idx: 2 }
                        ];
                        entries.sort((a, b) => b.score - a.score);

                        let finalPoints = [0, 0, 0];

                        // 3-way Tie
                        if (entries[0].score === entries[1].score && entries[1].score === entries[2].score) {
                            const avg = (pDist[0] + pDist[1] + pDist[2]) / 3;
                            finalPoints.fill(avg);
                        }
                        // Tie 1st
                        else if (entries[0].score === entries[1].score) {
                            const avg = (pDist[0] + pDist[1]) / 2;
                            finalPoints[entries[0].idx] = avg;
                            finalPoints[entries[1].idx] = avg;
                            finalPoints[entries[2].idx] = pDist[2];
                        }
                        // Tie 2nd
                        else if (entries[1].score === entries[2].score) {
                            finalPoints[entries[0].idx] = pDist[0];
                            const avg = (pDist[1] + pDist[2]) / 2;
                            finalPoints[entries[1].idx] = avg;
                            finalPoints[entries[2].idx] = avg;
                        }
                        // No Tie
                        else {
                            finalPoints[entries[0].idx] = pDist[0];
                            finalPoints[entries[1].idx] = pDist[1];
                            finalPoints[entries[2].idx] = pDist[2];
                        }

                        dpA = finalPoints[0];
                        dpB = finalPoints[1];
                        dpC = finalPoints[2];

                        tdpA += dpA; tdpB += dpB; tdpC += dpC;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 hover:bg-gray-900/50 transition-colors";

                    tr.innerHTML = `
                        <td class="p-4 border-r-2 border-gray-700 text-gray-400 font-bold">${d.code} - ${d.name}</td>
                        
                        <!-- Team A -->
                        <td class="p-2 text-center border-r border-gray-700 text-blue-400 font-bold text-2xl">${anyStarted ? dpA : '-'}</td>
                        <td class="p-2 text-center border-r-2 border-gray-700 text-white font-bold bg-gray-900/40 text-lg">${tdpA}</td>

                        <!-- Team B -->
                        <td class="p-2 text-center border-r border-gray-700 text-yellow-500 font-bold text-2xl">${anyStarted ? dpB : '-'}</td>
                        <td class="p-2 text-center border-r-2 border-gray-700 text-white font-bold bg-gray-900/40 text-lg">${tdpB}</td>

                        <!-- Team C -->
                        <td class="p-2 text-center border-r border-gray-700 text-red-500 font-bold text-2xl">${anyStarted ? dpC : '-'}</td>
                        <td class="p-2 text-center text-white font-bold bg-gray-900/40 text-lg">${tdpC}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const foot = $('sheetFoot');
            foot.innerHTML = `
                <tr>
                    <td class="p-4 border-r border-gray-700">TOTAL</td>
                    <td class="p-2 text-center border-r border-gray-700 text-blue-400 font-bold text-3xl" colspan="2">${tdpA}</td>
                    <td class="p-2 text-center border-r border-gray-700 text-yellow-500 font-bold text-3xl" colspan="2">${tdpB}</td>
                    <td class="p-2 text-center border-r border-gray-700 text-red-500 font-bold text-3xl" colspan="2">${tdpC}</td>
                </tr>
            `;
        }

        // Safe Index Access with fallback for fetchTeams
        function getDisciplineIndex() {
            if (!activeDisciplineCode) return 0;
            const order = MAO_ORDERS[activeMao || 'A'];
            const idx = order.indexOf(activeDisciplineCode);
            return idx !== -1 ? idx : 0;
        }

        // --- 4. REALTIME ---
        function subscribeRealtime() {
            const channel = sbClient.channel('scoreboard_live');

            channel.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches', filter: `id=eq.${activeMatchId}` }, (payload) => {
                window.location.reload();
            });

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'scores', filter: `match_id=eq.${activeMatchId}` }, async (payload) => {
                await fetchAllScores();
            });

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'match_teams', filter: `match_id=eq.${activeMatchId}` }, () => {
                fetchTeams().then(fetchAllScores);
            });

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'station_assignments', filter: `match_id=eq.${activeMatchId}` }, () => {
                fetchStationLocks();
            });

            channel.subscribe();
        }

        // --- START ---
        initScoreboard();

    </script>
</body>

</html>